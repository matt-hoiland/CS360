#include <iostream>
#include <sstream>
#include <stdexcept>

#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

using namespace std;

struct args_t {
	bool debug;
	int port;
	const char* dir;
} args;

void parse_args(int argc, char** argv, struct args_t* args);
void setUpHandlers();

int main(int argc, char** argv) {
	parse_args(argc, argv, &args);

	setUpHandlers();

	return 0;
}

void parse_args(int argc, char** argv, struct args_t* args) {
	bool debug = false;
	int option;
	while ((option = getopt(argc, argv, "d")) != -1) {
		switch (option) {
		case 'd' :
			debug = true;
			break;
		default:
			cout << "USAGE: <port> <dir> [-d]" << endl;
			exit(-1);
		}
	}

	int port;
	istringstream num(argv[optind]);
	if (!(num >> port)) {
		cout << "USAGE: <port> should be a number, given: " << argv[optind] << endl;
		exit(-1);
	}

	const char* dir = argv[optind + 1];
	struct stat dirstat;

	if (stat(dir, &dirstat)) {
		cout << "ERROR: failed to stat " << dir << endl;
		exit(-1);
	}
	if (!S_ISDIR(dirstat.st_mode) || !(dirstat.st_mode & S_IROTH)) {
		cout << "USAGE: <dir> should be a public directory, given: " << dir << endl;
		exit(-1);
	}

	args->debug = debug;
	args->port = port;
	args->dir = dir;
}
